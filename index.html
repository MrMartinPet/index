<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Frekvensanalys – Lagledare</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" />
<style>
  :root{
    --bg:#f6f7fb; --card:#fff; --border:#e6e8ef; --text:#111827; --muted:#6b7280; --accent:#3a6ff8;
  }
  *{box-sizing:border-box; -webkit-tap-highlight-color:transparent}
  html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:560px;margin:0 auto;min-height:100dvh;display:flex;flex-direction:column}
  .topbar{position:sticky;top:0;z-index:5;background:linear-gradient(#fff,rgba(255,255,255,.85));border-bottom:1px solid var(--border);backdrop-filter:saturate(1.2) blur(6px);}
  .topbar .inner{padding:12px 14px}
  h1{margin:0;font-size:18px}
  .chip{display:inline-block;margin-top:6px;padding:6px 10px;border-radius:999px;background:#eef2ff;font-weight:600;font-size:12px}

  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 10px 24px rgba(0,0,0,.04);padding:12px;margin:12px 14px}
  .row{display:flex;gap:10px}
  .col{flex:1}
  input,select{width:100%;padding:14px 12px;border:1px solid var(--border);border-radius:12px;background:#fff;font-size:16px}
  .btn{display:inline-flex;align-items:center;justify-content:center;width:100%;padding:14px;border:none;border-radius:12px;background:var(--accent);color:#fff;font-weight:700;font-size:16px}
  .btn.secondary{background:#111827}
  .btn.ghost{background:#e5e7eb;color:#111827}
  .btn.small{padding:10px 12px;font-size:14px}
  .sectionTitle{font-weight:800;font-size:15px;margin:8px 14px}

  details{border:1px solid var(--border);border-radius:16px;overflow:hidden;margin:10px 14px}
  summary{list-style:none;padding:14px 16px;font-weight:800}
  summary::-webkit-details-marker{display:none}
  .subTitle{padding:8px 16px;font-weight:700;color:#111}
  .rowLine{display:flex;gap:8px;align-items:center;padding:10px 14px;border-top:1px solid var(--border)}
  .rowLine input{flex:1}
  .addRow{padding:12px 14px;border-top:1px dashed var(--border);display:flex;gap:8px}

  /* Analysis view */
  .nowBar{display:grid;grid-template-columns:1fr 120px;gap:10px}
  .pill{background:#6b7280;color:#fff;border-radius:16px;padding:18px;display:flex;align-items:center;justify-content:center;text-align:center;font-size:18px;font-weight:800;min-height:76px}
  .timer{background:#374151;color:#fff;border-radius:16px;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:20px}
  .toolbar{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
  .list{display:flex;flex-direction:column;gap:8px}
  .rowBtn{display:grid;grid-template-columns:1fr 100px;gap:10px;align-items:center}
  .btnAct{padding:14px;border:none;border-radius:12px;background:#f5e1bf;font-weight:800;font-size:16px;text-align:left}
  .badge{padding:12px;border-radius:12px;background:#f1f5f9;text-align:center;font-weight:800}
  .fab{position:fixed;inset:auto 16px 16px auto;width:56px;height:56px;border-radius:50%;border:none;background:var(--accent);color:#fff;font-size:28px;display:flex;align-items:center;justify-content:center;box-shadow:0 14px 28px rgba(58,111,248,.35)}
  canvas{max-width:100%}
</style>
</head>
<body>
<div class="wrap">
  <div class="topbar"><div class="inner">
    <h1>Frekvensanalys</h1>
    <div id="sessionChip" class="chip" hidden></div>
  </div></div>

  <!-- SETUP -->
  <section id="setup">
    <div class="card">
      <div class="row">
        <div class="col"><input id="leader" placeholder="Lagledare"></div>
        <div class="col"><input id="flow" placeholder="Flöde"></div>
      </div>
      <div class="row" style="margin-top:8px">
        <div class="col"><input id="date" type="date"></div>
        <div class="col"><button class="btn" onclick="startSession()">Starta analys</button></div>
      </div>
    </div>

    <div class="sectionTitle">Kategorier, underkategorier & aktiviteter</div>
    <div id="editor"></div>

    <div class="card">
      <div class="row">
        <input id="newCatName" placeholder="Ny kategori">
        <button class="btn ghost" onclick="addCategory()">Lägg till kategori</button>
      </div>
    </div>
  </section>

  <!-- ANALYSIS -->
  <section id="analysis" hidden>
    <div class="card">
      <div class="nowBar">
        <div class="pill" id="currentAct">–</div>
        <div class="timer" id="liveTimer">00:00:00</div>
      </div>
      <div class="toolbar">
        <button id="pauseBtn" class="btn ghost" onclick="pauseActivity()">Pausa aktivitet</button>
        <button class="btn secondary" onclick="finishSession()">Avsluta</button>
      </div>
    </div>

    <div class="card">
      <div class="row" style="gap:8px">
        <input id="adHocName" placeholder="Lägg till aktivitet…">
        <select id="adHocCat" onchange="fillSubSelect()"></select>
        <select id="adHocSub"></select>
        <button class="btn small" style="width:auto" onclick="addActivityDynamic()">+ Lägg till</button>
      </div>
    </div>

    <div class="card"><div id="actList" class="list"></div></div>
    <button class="fab" title="Ny aktivitet" onclick="document.getElementById('adHocName').focus()">＋</button>
  </section>

  <!-- SUMMARY -->
  <section id="summary" hidden>
    <div class="card">
      <div class="row">
        <div class="col"><button class="btn ghost" onclick="downloadCSV()">Exportera CSV</button></div>
        <div class="col"><button class="btn" onclick="window.location.reload()">Ny analys</button></div>
      </div>
    </div>
    <div class="card"><canvas id="pie"></canvas></div>
    <div class="card"><div id="totals" class="list"></div></div>
  </section>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// FULL DATASET – kategori -> underkategori -> aktiviteter
const model = {
  header:{leader:"",flow:"",date:""},
  tree:[
    {name:"Produktionsplanering", color:"#e8f0ff", subs:[
      {name:"I Monitor", acts:[
        "Planering formning","Planering borrning","Planering limning","Planering fräsning"]},
      {name:"Powerapp", acts:["Beställning i app"]},
      {name:"Excel", acts:["Planering"]},
      {name:"Överlämning", acts:["Förberedelse av Överlämning"]}
    ]},
    {name:"Möten", color:"#eaf7e8", subs:[
      {name:"Planerat möte", acts:[
        "Skiftstartsmöte","Morgomöte","Övrigt möte","Övrig Personalplanering",
        "Personalplaneringsmöte","Skiftöverlämning","QROC","QRSC"]}
    ]},
    {name:"Problem", color:"#fff9db", subs:[
      {name:"Problemlösning", acts:[
        "Kvalitetsproblem","Verktygsproblem","Materialproblem","Emballageproblem","Maskinproblem"]}
    ]},
    {name:"Logistik", color:"#ffe8d9", subs:[
      {name:"Från inruta", acts:[
        "Material till fräslokal","Material till torg","Material till Formning","Verktyg till Limhjul",
        "Verktyg till Fräslokal","Emballage till Fräslokal","Binge till fräslokal","Övrigt in till flöde"]},
      {name:"Från Materialtorg", acts:["Material till LH","Material till Fräs"]},
      {name:"Från Formning", acts:[
        "Material till Frästorg","Material till Limtorg LH","Material till Limtorg Byrå","Material till utruta","Verktyg till utruta"]},
      {name:"Från Fräsning", acts:[
        "Verktyg till Hans","Verktyg till ställage i fräs","Verktyg till utruta","Vinkel till torg",
        "Material till monteringstorg","Tompall till utruta","Verktyg till bäddfräs (ställage)"]},
      {name:"Från Limning", acts:[
        "Verktyg till Laura","Verktyg till vagnsplats golv","Verktyg till utruta","Tompall till utruta",
        "Överblivet material till utruta","Vinkel till torg"]},
      {name:"Från Verktygshiss/Vagnsplats", acts:[
        "Verktyg från Laura till LH","Verktyg från Hans till fräslokal","Verktyg från golvplats till LH"]},
      {name:"Övrigt", acts:[
        "Packlåda till fräs","Tompall/vagn till fräs","Tomvagn till fräs","Ingående komponenter","Gång","Rast"]}
    ]}
  ],
  totals:{}, // aktivitet -> sekunder
  sessionStart:0, sessionRAF:0,
  active:null, activeStart:0, history:[], paused:false
};

// =========== SETUP EDITOR ==========
function renderEditor(){
  const host = document.getElementById('editor');
  host.innerHTML='';
  model.tree.forEach((cat,ci)=>{
    const d=document.createElement('details');
    d.style.background=cat.color||'#fff';
    const s=document.createElement('summary'); s.textContent=cat.name; d.appendChild(s);

    cat.subs.forEach((sub,si)=>{
      const t=document.createElement('div'); t.className='subTitle'; t.textContent=sub.name; d.appendChild(t);
      sub.acts.forEach((act,ai)=>{
        const r=document.createElement('div'); r.className='rowLine';
        r.innerHTML=`<input value="${act}" onchange="renameAct(${ci},${si},${ai},this.value)">`+
          `<button class='btn small ghost' style='width:auto' onclick='delAct(${ci},${si},${ai})'>Ta bort</button>`;
        d.appendChild(r);
      });
      const add=document.createElement('div'); add.className='addRow';
      add.innerHTML=`<input placeholder='Ny aktivitet i ${sub.name}'>`+
        `<button class='btn small' style='width:auto' onclick='pushAct(${ci},${si}, this.previousElementSibling.value)'>+ Lägg till</button>`;
      d.appendChild(add);
    });

    const ren=document.createElement('div'); ren.className='addRow';
    ren.innerHTML=`<input value='${cat.name}' onchange='renameCat(${ci},this.value)'>`;
    d.appendChild(ren);
    host.appendChild(d);
  });
  fillCatSelect(); fillSubSelect();
}
function addCategory(){ const n=document.getElementById('newCatName').value.trim(); if(!n) return; model.tree.push({name:n,color:'#fff',subs:[]}); document.getElementById('newCatName').value=''; renderEditor(); }
function renameCat(ci,v){ model.tree[ci].name=v; renderEditor(); }
function renameAct(ci,si,ai,v){ model.tree[ci].subs[si].acts[ai]=v; renderEditor(); }
function delAct(ci,si,ai){ model.tree[ci].subs[si].acts.splice(ai,1); renderEditor(); }
function pushAct(ci,si,name){ if(!name) return; model.tree[ci].subs[si].acts.push(name); renderEditor(); }
function fillCatSelect(){ const sel=document.getElementById('adHocCat'); sel.innerHTML=model.tree.map((c,i)=>`<option value='${i}'>${c.name}</option>`).join(''); }
function fillSubSelect(){ const ci=+document.getElementById('adHocCat').value||0; const subSel=document.getElementById('adHocSub'); const subs=model.tree[ci]?.subs||[]; subSel.innerHTML=subs.map((s,i)=>`<option value='${i}'>${s.name}</option>`).join(''); }

// =========== ANALYSIS ==========
function startSession(){
  model.header.leader=document.getElementById('leader').value.trim();
  model.header.flow=document.getElementById('flow').value.trim();
  model.header.date=document.getElementById('date').value;
  // Prepare totals for all acts
  model.tree.forEach(c=>c.subs.forEach(s=>s.acts.forEach(a=>model.totals[a]=0)));
  model.sessionStart=performance.now();
  renderActList();
  document.getElementById('setup').hidden=true; document.getElementById('analysis').hidden=false;
  const chip=document.getElementById('sessionChip'); chip.hidden=false; chip.textContent=`${model.header.leader||'Lagledare'} · ${model.header.flow||'Flöde'} · ${new Date().toLocaleDateString('sv-SE')}`;
  tick();
}
function renderActList(){
  const host=document.getElementById('actList'); host.innerHTML='';
  model.tree.forEach(c=>c.subs.forEach(s=>s.acts.forEach(a=>{
    const row=document.createElement('div'); row.className='rowBtn';
    row.innerHTML=`<button class='btnAct' onclick='selectActivity("${a.replaceAll("\"","&quot;")}")'>${a}</button>`+
                   `<div class='badge' id='sum_${hash(a)}'>00:00:00</div>`;
    host.appendChild(row);
  })));
}
function addActivityDynamic(){
  const name=document.getElementById('adHocName').value.trim(); if(!name) return;
  const ci=+document.getElementById('adHocCat').value||0; const si=+document.getElementById('adHocSub').value||0;
  const sub=model.tree[ci].subs[si]; sub.acts.push(name); model.totals[name]=0; document.getElementById('adHocName').value=''; renderActList();
}
function selectActivity(name){
  const now=performance.now();
  if(model.active){
    const d=(now-model.activeStart)/1000; model.totals[model.active]=(model.totals[model.active]||0)+d; model.history.push({act:model.active,start:model.activeStart,end:now});
  }
  model.active=name; model.activeStart=now; model.paused=false;
  document.getElementById('currentAct').textContent=name; setLive(0);
}
function pauseActivity(){
  if(!model.active) return; const now=performance.now(); const d=(now-model.activeStart)/1000; model.totals[model.active]+=(d>0?d:0); model.history.push({act:model.active,start:model.activeStart,end:now}); model.active=null; model.paused=true; document.getElementById('currentAct').textContent='Pausad'; setLive(0);
}
function tick(){
  // live timer
  if(model.active){ const d=(performance.now()-model.activeStart)/1000; setLive(d); }
  // update badges preview (includes current running)
  const preview={...model.totals}; if(model.active){ preview[model.active]=(preview[model.active]||0)+((performance.now()-model.activeStart)/1000); }
  for(const [k,v] of Object.entries(preview)){ const el=document.getElementById('sum_'+hash(k)); if(el) el.textContent=fmt(v); }
  model.sessionRAF=requestAnimationFrame(tick);
}
function finishSession(){
  if(model.active){ const now=performance.now(); const d=(now-model.activeStart)/1000; model.totals[model.active]+=d; model.history.push({act:model.active,start:model.activeStart,end:now}); model.active=null; }
  cancelAnimationFrame(model.sessionRAF);
  document.getElementById('analysis').hidden=true; document.getElementById('summary').hidden=false; renderSummary();
}

// =========== SUMMARY & EXPORT ==========
function renderSummary(){
  const labels=Object.keys(model.totals); const data=labels.map(k=>Math.round(model.totals[k]));
  new Chart(document.getElementById('pie'),{type:'pie',data:{labels,datasets:[{data}]},options:{plugins:{legend:{position:'bottom'}}}});
  const list=document.getElementById('totals'); list.innerHTML=labels.filter(l=>model.totals[l]>0).map(l=>`<div class='rowBtn'><div class='btnAct' style='background:#eef2ff'>${l}</div><div class='badge'>${fmt(model.totals[l])}</div></div>`).join('');
}
function downloadCSV(){
  const base=Date.now()-(performance.now()-model.sessionStart);
  const rows=[["Lagledare",model.header.leader],["Flöde",model.header.flow],["Datum",model.header.date||new Date(base).toLocaleDateString('sv-SE')],["\n"],["Aktivitet","Start","Slut","Sekunder"]];
  model.history.forEach(h=>{ rows.push([h.act,new Date(base+(h.start-model.sessionStart)).toISOString(),new Date(base+(h.end-model.sessionStart)).toISOString(),((h.end-h.start)/1000|0)]); });
  rows.push(["\n"],["SUMMA"],...Object.entries(model.totals).map(([k,v])=>[k,'','',Math.round(v)]));
  const csv=rows.map(r=>r.join(';')).join('\n'); const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'})); a.download='frekvensanalys.csv'; a.click();
}

// =========== HELPERS ==========
function hash(s){ let h=0; for(let i=0;i<s.length;i++){ h=((h<<5)-h)+s.charCodeAt(i); h|=0; } return 'h'+Math.abs(h); }
function fmt(sec){ sec=Math.max(0,sec|0); const h=(''+Math.floor(sec/3600)).padStart(2,'0'); const m=(''+Math.floor((sec%3600)/60)).padStart(2,'0'); const s=(''+(sec%60)).padStart(2,'0'); return `${h}:${m}:${s}`; }
function setLive(s){ document.getElementById('liveTimer').textContent=fmt(s); }

// ====== SAFETY: Warn on exit during active session ======
window.addEventListener("beforeunload", function (e) {
  if (document.getElementById('analysis') && !document.getElementById('analysis').hidden) {
    e.preventDefault();
    e.returnValue = "Du håller på att avsluta analysen. All tid kan förloras om du lämnar sidan.";
    return "Du håller på att avsluta analysen. All tid kan förloras om du lämnar sidan.";
  }
});

// boot
renderEditor();
</script>
</body>
</html>
